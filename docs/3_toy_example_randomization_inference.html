<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
  <title>Estimating the Local Air Pollution Impacts of Cruise Traffic: Toy Example for Understanding Randomization Inference</title>

  <meta property="description" itemprop="description" content="How to Compute Fisherian Intervals?"/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2022-08-03"/>
  <meta property="article:created" itemprop="dateCreated" content="2022-08-03"/>
  <meta name="article:author" content="Marie-Abèle Bind"/>
  <meta name="article:author" content="Marion Leroutier"/>
  <meta name="article:author" content="Léo Zabrocki"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Estimating the Local Air Pollution Impacts of Cruise Traffic: Toy Example for Understanding Randomization Inference"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="How to Compute Fisherian Intervals?"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Estimating the Local Air Pollution Impacts of Cruise Traffic"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Estimating the Local Air Pollution Impacts of Cruise Traffic: Toy Example for Understanding Randomization Inference"/>
  <meta property="twitter:description" content="How to Compute Fisherian Intervals?"/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","output"]}},"value":[{"type":"character","attributes":{},"value":["Toy Example for Understanding Randomization Inference"]},{"type":"character","attributes":{},"value":["How to Compute Fisherian Intervals?\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Marie-Abèle Bind"]},{"type":"character","attributes":{},"value":["https://scholar.harvard.edu/marie-abele"]},{"type":"character","attributes":{},"value":["Biostatistics Center, Massachusetts General Hospital"]},{"type":"character","attributes":{},"value":["https://biostatistics.massgeneral.org/faculty/marie-abele-bind-phd/"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Marion Leroutier"]},{"type":"character","attributes":{},"value":["https://www.parisschoolofeconomics.eu/en/leroutier-marion/work-in-progress/"]},{"type":"character","attributes":{},"value":["Misum, Stockholm School of Economics"]},{"type":"character","attributes":{},"value":["https://www.hhs.se/en/persons/l/leroutier-marion/"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Léo Zabrocki"]},{"type":"character","attributes":{},"value":["https://lzabrocki.github.io/"]},{"type":"character","attributes":{},"value":["RFF-CMCC EIEE"]},{"type":"character","attributes":{},"value":["https://www.eiee.org/"]}]}]},{"type":"character","attributes":{},"value":["2022-08-03"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc","toc_depth"]}},"value":[{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[3]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          return "<p>" + $('#ref-' + ref).html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <style type="text/css">
  /* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */



  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       1.06rem;
    --code-size:       14px;
    --aside-size:      12px;
    --fig-cap-size:    13px;
    /*-- Main font colors --*/
    --title-color:     #000000;
    --header-color:    rgba(0, 0, 0, 0.8);
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     rgba(0, 0, 0, 0.6);
    --fig-cap-color:   rgba(0, 0, 0, 0.6);
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    sans-serif;
    --mono-font:       monospace;
    --body-font:       sans-serif;
    --navbar-font:     sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    0.6rem;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       0.8rem;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    18px;
    --contents-size:   13px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --title-size:       18px;
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  .distill-site-footer {
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */
  </style>
  <style type="text/css">/* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed');
  @import url('https://fonts.googleapis.com/css2?family=Oswald');
  @import url('https://fonts.googleapis.com/css2?family=Fira+Mono');

  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       20px;
    --code-size:       12px;
    --aside-size:      12px;
    --fig-cap-size:    13px;
    /*-- Main font colors --*/
    --title-color:     #0471a6;
    --header-color:    #0471a6;
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     #0471a6;
    --fig-cap-color:   #0471a6;
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    'Oswald', sans-serif;
    --mono-font:       'Fira Mono', monospace;
    --body-font:       'Roboto Condensed', serif;
    --navbar-font:     'Oswald', sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    18px;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       15px;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    20px;
    --contents-size:   18px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --title-size:       20px;
    --text-color:       #0471a6;
    --text-size:        20px;
    --hover-color:      #f4a261;
    --bkgd-color:       #FFFFFF;
    --font-weight:      700;

  }

  .distill-site-footer {
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #FFFFFF;
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */

  a:link {
    color: #0471a6;
  }

  /* mouse over link */
  a:hover {
    color: #f4a261;
  }


  a:visited {
    color: #0471a6;
  }

  /* Postcard headers */
  h1, h2, h3 {
    color: #0471a6;
  }


  /* Buttons on home page */

  .btn-outline-dark {
      background-color: #fff;
      font-size: 30px;
      color: #0471a6;
      border: 0px;
  }

  .btn-outline-dark:hover {
      background-color: #f4a261;
  }


  aside {
      float: right;
      color: blue;
  }</style>
  <style type="text/css">
  /* base style */

  /* FONT FAMILIES */

  :root {
    --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  body,
  .posts-list .post-preview p,
  .posts-list .description p {
    font-family: var(--body-font), var(--body-default);
  }

  h1, h2, h3, h4, h5, h6,
  .posts-list .post-preview h2,
  .posts-list .description h2 {
    font-family: var(--heading-font), var(--heading-default);
  }

  d-article div.sourceCode code,
  d-article pre code {
    font-family: var(--mono-font), var(--mono-default);
  }


  /*-- TITLE --*/
  d-title h1,
  .posts-list > h1 {
    color: var(--title-color, black);
  }

  d-title h1 {
    font-size: var(--title-size, 50px);
  }

  /*-- HEADERS --*/
  d-article h1,
  d-article h2,
  d-article h3,
  d-article h4,
  d-article h5,
  d-article h6 {
    color: var(--header-color, rgba(0, 0, 0, 0.8));
  }

  /*-- BODY --*/
  d-article > p,  /* only text inside of <p> tags */
  d-article > ul, /* lists */
  d-article > ol {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
    font-size: var(--body-size, 1.06rem);
  }


  /*-- CODE --*/
  d-article div.sourceCode code,
  d-article pre code {
    font-size: var(--code-size, 14px);
  }

  /*-- ASIDE --*/
  d-article aside {
    font-size: var(--aside-size, 12px);
    color: var(--aside-color, rgba(0, 0, 0, 0.6));
  }

  /*-- FIGURE CAPTIONS --*/
  figure .caption,
  figure figcaption,
  .figure .caption {
    font-size: var(--fig-cap-size, 13px);
    color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
  }

  /*-- METADATA --*/
  d-byline h3 {
    font-size: var(--heading-size, 0.6rem);
    color: var(--heading-color, rgba(0, 0, 0, 0.5));
  }

  d-byline {
    font-size: var(--body-size, 0.8rem);
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  d-byline a,
  d-article d-byline a {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  /*-- TABLE OF CONTENTS --*/
  .d-contents nav h3 {
    font-size: var(--heading-size, 18px);
  }

  .d-contents nav a {
    font-size: var(--contents-size, 13px);
  }

  /*-- APPENDIX --*/
  d-appendix h3 {
    font-size: var(--heading-size, 15px);
    color: var(--heading-color, rgba(0, 0, 0, 0.65));
  }

  d-appendix {
    font-size: var(--text-size, 0.8em);
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  d-appendix d-footnote-list a.footnote-backlink {
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  .distill-site-header .title {
    font-size: var(--title-size, 18px);
    font-family: var(--navbar-font), var(--heading-default);
  }

  .distill-site-header a,
  .nav-dropdown .nav-dropbtn {
    font-family: var(--navbar-font), var(--heading-default);
  }

  .nav-dropdown .nav-dropbtn {
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    font-size: var(--text-size, 15px);
  }

  .distill-site-header a:hover,
  .nav-dropdown:hover .nav-dropbtn {
    color: var(--hover-color, white);
  }

  .distill-site-header {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer a:hover {
    color: var(--hover-color, white);
  }</style>
  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
  <script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
  <link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Toy Example for Understanding Randomization Inference","description":"How to Compute Fisherian Intervals?","authors":[{"author":"Marie-Abèle Bind","authorURL":"https://scholar.harvard.edu/marie-abele","affiliation":"Biostatistics Center, Massachusetts General Hospital","affiliationURL":"https://biostatistics.massgeneral.org/faculty/marie-abele-bind-phd/","orcidID":""},{"author":"Marion Leroutier","authorURL":"https://www.parisschoolofeconomics.eu/en/leroutier-marion/work-in-progress/","affiliation":"Misum, Stockholm School of Economics","affiliationURL":"https://www.hhs.se/en/persons/l/leroutier-marion/","orcidID":""},{"author":"Léo Zabrocki","authorURL":"https://lzabrocki.github.io/","affiliation":"RFF-CMCC EIEE","affiliationURL":"https://www.eiee.org/","orcidID":""}],"publishedDate":"2022-08-03T00:00:00.000+02:00","citationText":"Bind, et al., 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">Estimating the Local Air Pollution Impacts of Cruise Traffic</a>
</div>
<div class="nav-right">
<a href="index.html">Home</a>
<a href="https://arxiv.org/abs/2105.03996">Article</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Data
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="1_1_hourly_data_wrangling.html">Hourly Data Wrangling</a>
<a href="1_2_hourly_eda.html">Hourly EDA</a>
<a href="2_1_daily_data_wrangling.html">Daily Data Wrangling</a>
<a href="2_2_daily_eda.html">Daily EDA</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Hourly Matching
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="1_3_hourly_matching_procedure.html">Matching Procedure</a>
<a href="1_4_hourly_comparing_matching_matched_data.html">Comparing Matching &amp; Matched Data</a>
<a href="1_5_hourly_checking_intervention.html">Checking Intervention</a>
<a href="1_6_hourly_checking_balance.html">Checking Balance</a>
<a href="1_7_hourly_checking_balance_improvement.html">Checking Balance Improvement</a>
<a href="1_8_hourly_analysis_results.html">Treatment Analysis</a>
<a href="1_9_hourly_regression_analysis.html">Outcome Regression</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Daily Matching
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="2_3_daily_matching_procedure.html">Matching Procedure</a>
<a href="2_4_daily_comparing_matching_matched_data.html">Comparing Matching &amp; Matched Data</a>
<a href="2_5_daily_checking_intervention.html">Checking Intervention</a>
<a href="2_6_daily_checking_balance.html">Checking Balance</a>
<a href="2_7_daily_checking_balance_improvement.html">Checking Balance Improvement</a>
<a href="2_8_daily_analysis_results.html">Treatment Analysis</a>
<a href="2_9_daily_regression_analysis.html">Outcome Regression</a>
<a href="2_10_daily_road_traffic_analysis.html">Road Traffic Analysis</a>
</div>
</div>
<a href="3_toy_example_randomization_inference.html">Tutorial Randomization Inference</a>
<a href="https://github.com/lzabrocki/cruise_air_pollution.git" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Toy Example for Understanding Randomization Inference</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>How to Compute Fisherian Intervals?</p></p>
</div>

<div class="d-byline">
  Marie-Abèle Bind <a href="https://scholar.harvard.edu/marie-abele"
class="uri">https://scholar.harvard.edu/marie-abele</a> (Biostatistics
Center, Massachusetts General Hospital)<a
href="https://biostatistics.massgeneral.org/faculty/marie-abele-bind-phd/"
class="uri">https://biostatistics.massgeneral.org/faculty/marie-abele-bind-phd/</a>
  
,   Marion Leroutier <a
href="https://www.parisschoolofeconomics.eu/en/leroutier-marion/work-in-progress/"
class="uri">https://www.parisschoolofeconomics.eu/en/leroutier-marion/work-in-progress/</a> (Misum,
Stockholm School of Economics)<a
href="https://www.hhs.se/en/persons/l/leroutier-marion/"
class="uri">https://www.hhs.se/en/persons/l/leroutier-marion/</a>
  
,   Léo Zabrocki <a href="https://lzabrocki.github.io/"
class="uri">https://lzabrocki.github.io/</a> (RFF-CMCC EIEE)<a
href="https://www.eiee.org/" class="uri">https://www.eiee.org/</a>
  
<br/>2022-08-03
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#required-packages">Required Packages</a></li>
<li><a href="#toy-example">Toy Example</a>
<ul>
<li><a href="#science-table">Science Table</a></li>
<li><a href="#observed-data">Observed Data</a></li>
</ul></li>
<li><a href="#testing-the-sharp-null-hypothesis-of-no-treatment">Testing
the Sharp Null Hypothesis of No Treatment</a>
<ul>
<li><a href="#stating-the-hypothesis">Stating the Hypothesis</a></li>
<li><a href="#computional-shortcut">Computional Shortcut</a></li>
<li><a
href="#computing-the-null-distribution-of-the-test-statistic">Computing
the Null Distribution of the Test Statistic</a></li>
<li><a href="#computing-the-two-sided-p-value">Computing the Two-Sided
P-Value</a></li>
</ul></li>
<li><a
href="#computing-a-95-fisherian-intervals-for-a-range-of-sharp-null-hypotheses">Computing
a 95% Fisherian Intervals for a Range of Sharp Null Hypotheses</a>
<ul>
<li><a href="#steps-of-the-procedure">Steps of the Procedure</a></li>
<li><a href="#computational-shortcut">Computational Shortcut</a></li>
<li><a href="#implementation-in-r">Implementation in R</a></li>
</ul></li>
<li><a href="#comparison-with-neymans-approach">Comparison with Neyman’s
Approach</a></li>
<li><a
href="#computing-a-95-fisherian-intervals-for-weak-null-hypotheses">Computing
a 95% Fisherian Intervals For Weak Null Hypotheses</a></li>
</ul>
</nav>
</div>
<style>
body {
text-align: justify}
</style>
<p>In this document, we explain with a toy example how to:</p>
<ul>
<li>Test the sharp null hypothesis of no effect for all units.</li>
<li>Carry out a test inversion procedure to compute a 95% Fisherian
interval for constant treatment effects consistent with the data.</li>
<li>Compare the results with Neyman’s approach targeting the average
causal effect.</li>
<li>Adapt the randomization inference for testing weak null hypotheses
(i.e., average causal effects).</li>
</ul>
<p><strong>Should you have any questions, need help to reproduce the
analysis or find coding errors, please do not hesitate to contact us at
<a href="mailto:leo.zabrocki@gmail.com"
class="email">leo.zabrocki@gmail.com</a> and <a
href="mailto:marion.leroutier@hhs.se"
class="email">marion.leroutier@hhs.se</a>.</strong></p>
<h1 id="required-packages">Required Packages</h1>
<p>We load the following packages:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># load required packages</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://yihui.org/knitr/'>knitr</a></span><span class='op'>)</span> <span class='co'># for creating the R Markdown document</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://here.r-lib.org/'>here</a></span><span class='op'>)</span> <span class='co'># for files paths organization</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span> <span class='co'># for data manipulation and visualization</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://haozhu233.github.io/kableExtra/'>kableExtra</a></span><span class='op'>)</span> <span class='co'># for building nice tables</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.rforge.net/Cairo/'>Cairo</a></span><span class='op'>)</span> <span class='co'># for printing custom police of graphs</span>
</code></pre>
</div>
</div>
<p>We finally load our custom <code>ggplot2</code> theme for graphs:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># load ggplot custom theme</span>
<span class='kw'><a href='https://rdrr.io/r/base/source.html'>source</a></span><span class='op'>(</span><span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span>
  <span class='st'>"inputs"</span>,
  <span class='st'>"2.functions"</span>,
  <span class='st'>"script_theme_tufte.R"</span>
<span class='op'>)</span><span class='op'>)</span>
<span class='co'># define nice colors</span>
<span class='va'>my_blue</span> <span class='op'>&lt;-</span> <span class='st'>"#0081a7"</span>
<span class='va'>my_orange</span> <span class='op'>&lt;-</span> <span class='st'>"#fb8500"</span>
</code></pre>
</div>
</div>
<h1 id="toy-example">Toy Example</h1>
<p>In this toy example, we aim to estimate the effect of cruise vessels
docking at Marseille’s port on NO<span
class="math inline">\(_{2}\)</span> concentration:</p>
<ul>
<li>For simplicity, imagine that our matching procedure resulted in 10
pairs of hours with similar weather and calendar characteristics (i.e.,
same average temperature, same day of the week, etc…).</li>
<li>Treated units are hours with cruise vessels docking at the port
while control units are hours without cruise vessels.</li>
<li>The outcome of the experiment is the hourly NO<span
class="math inline">\(_{2}\)</span> concentration measured at a station
located in the city.</li>
</ul>
<p>The exposition of this toy example is inspired by those found in the
chapter II of <a
href="https://link.springer.com/book/10.1007/978-3-030-46405-9">Paul
Rosenbaum’s textbook</a> and Tirthankar Dasgupta and Donald B. Rubin’s
forthcoming textbook (<em>Experimental Design: A Randomization-Based
Perspective</em>).</p>
<h3 id="science-table">Science Table</h3>
<p>We display below the Science Table of our imaginary experiment, that
is to say the table showing the treatment status and potential outcomes
for each observation:</p>
<ul>
<li>The first column <strong>Pair</strong> is the indicator of the pair.
We represent the index of a pair by <em>i</em> which takes values from 1
to 5.</li>
<li>The second column <strong>Unit Index</strong> is the index
<em>j</em> of a unit within the pair (<em>j</em> is equal to 1 for the
first unit in the pair and to 2 for the second unit).</li>
<li>The third column <strong>W</strong> indicates the treatment
allocation. W = 1 for treated units and W = 0 for controls.</li>
<li>The fourth and fifth columns are the potential outcomes of each unit
and represent the NO<span class="math inline">\(_{2}\)</span>
concentrations measured in <span class="math inline">\(\mu
g/m^{3}\)</span>. Y(W = 0) is the potential outcome when the unit does
not receive the treatment and Y(W = 1) is the potential outcome when the
unit is treated. As this is an artificial example, we imagine that we
know for each unit the values of both potential outcomes.</li>
<li>The six column <span class="math inline">\(\tau\)</span> is the unit
constant causal effect. Here, the causal effect is equal to +3 <span
class="math inline">\(\mu g/m^{3}\)</span>.</li>
<li>The last column <strong>Y<span
class="math inline">\(^{obs}\)</span></strong> represents the potential
outcome that we would observe according to the treatment allocation,
that is to say <span class="math inline">\(Y_{i,j} = W_{i,j}\times
Y_{i,j}(1) + (1-W_{i,j})\times Y_{i,j}(0)\)</span>. Here, in each pair,
the first unit does not receive the treatment so that we observe Y(0)
while the second unit is treated and we observe Y(1).</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># load the science table</span>
<span class='va'>science_table</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"inputs"</span>, <span class='st'>"1.data"</span>, <span class='st'>"3.toy_example"</span>, <span class='st'>"science_table.RDS"</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>science_table</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>
    Pair <span class='op'>=</span> <span class='va'>pair</span>,
    <span class='st'>"Unit Index"</span> <span class='op'>=</span> <span class='va'>unit</span>,
    W <span class='op'>=</span> <span class='va'>w</span>,
    <span class='st'>"Y(0)"</span> <span class='op'>=</span> <span class='va'>y_0</span>,
    <span class='st'>"Y(1)"</span> <span class='op'>=</span> <span class='va'>y_1</span>,
    <span class='st'>"$\\tau$"</span> <span class='op'>=</span> <span class='va'>tau</span>,
    <span class='st'>"Y$^{obs}$"</span> <span class='op'>=</span> <span class='va'>y</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/knitr/man/kable.html'>kable</a></span><span class='op'>(</span>align <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"c"</span>, <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/kableExtra/man/kable_styling.html'>kable_styling</a></span><span class='op'>(</span>position <span class='op'>=</span> <span class='st'>"center"</span><span class='op'>)</span>
</code></pre>
</div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Pair
</th>
<th style="text-align:center;">
Unit Index
</th>
<th style="text-align:center;">
W
</th>
<th style="text-align:center;">
Y(0)
</th>
<th style="text-align:center;">
Y(1)
</th>
<th style="text-align:center;">
<span class="math inline">\(\tau\)</span>
</th>
<th style="text-align:center;">
Y<span class="math inline">\(^{obs}\)</span>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
37
</td>
<td style="text-align:center;">
40
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
37
</td>
</tr>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
21
</td>
<td style="text-align:center;">
24
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
24
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
36
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
22
</td>
<td style="text-align:center;">
25
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
25
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
38
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
38
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
50
</td>
<td style="text-align:center;">
53
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
53
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
44
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
47
</td>
<td style="text-align:center;">
50
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
50
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
44
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
56
</td>
<td style="text-align:center;">
59
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
59
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
36
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
40
</td>
<td style="text-align:center;">
43
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
43
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
23
</td>
<td style="text-align:center;">
26
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
23
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
28
</td>
<td style="text-align:center;">
31
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
31
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
30
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
31
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
34
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
30
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
19
</td>
<td style="text-align:center;">
22
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
22
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
51
</td>
<td style="text-align:center;">
54
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
51
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
31
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
3
</td>
<td style="text-align:center;">
34
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="observed-data">Observed Data</h3>
<p>In reality, we do not have access to the Science Table but the table
below where we only have information on the pair indicator, the unit
index, the treatment allocated and the observed NO<span
class="math inline">\(_{2}\)</span> concentration. Our randomization
inference procedure will be based only on this table.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># create observed data</span>
<span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>science_table</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>pair</span>, <span class='va'>unit</span>, <span class='va'>w</span>, <span class='va'>y</span><span class='op'>)</span>

<span class='co'># display observed data</span>
<span class='va'>data</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>Pair <span class='op'>=</span> <span class='va'>pair</span>, <span class='st'>"Unit Index"</span> <span class='op'>=</span> <span class='va'>unit</span>, W <span class='op'>=</span> <span class='va'>w</span>, <span class='st'>"Y$^{obs}$"</span> <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/knitr/man/kable.html'>kable</a></span><span class='op'>(</span>align <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"c"</span>, <span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/kableExtra/man/kable_styling.html'>kable_styling</a></span><span class='op'>(</span>position <span class='op'>=</span> <span class='st'>"center"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Pair
</th>
<th style="text-align:center;">
Unit Index
</th>
<th style="text-align:center;">
W
</th>
<th style="text-align:center;">
Y<span class="math inline">\(^{obs}\)</span>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
37
</td>
</tr>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
24
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
25
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
38
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
53
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
50
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
59
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
43
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
23
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
31
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
34
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
22
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
51
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
34
</td>
</tr>
</tbody>
</table>
</div>
<p>Before moving to the inference, we need to:</p>
<ul>
<li>Know the number of unique treatment allocations. In a pair
experiment, there are <span class="math inline">\(2^{I}\)</span> unique
treatment allocations, with <em>I</em> is the number of pairs. In this
experiment, there are <span class="math inline">\(2^{10} = 1024\)</span>
unique treatment allocations.</li>
<li>Define a test statistic. We will build its distribution under the
sharp null hypothesis. Here, we use the average of pair differences as a
test statistic.</li>
</ul>
<h1 id="testing-the-sharp-null-hypothesis-of-no-treatment">Testing the
Sharp Null Hypothesis of No Treatment</h1>
<h3 id="stating-the-hypothesis">Stating the Hypothesis</h3>
<p>The sharp null hypothesis of no treatment states that <span
class="math inline">\(\forall i,j\)</span>, <span
class="math inline">\(H_{0}: Y_{i,j}(0) = Y_{i,j}(1)\)</span>, that is
to say the treatment has no effect for each unit. With this assumption,
we could impute the missing Y(1) for control units and the missing Y(0)
for treated units as shown in the table below :</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># display imputed observed data</span>
<span class='va'>data</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span><span class='st'>"Y(0)"</span> <span class='op'>=</span> <span class='va'>y</span>,
         <span class='st'>"Y(1)"</span> <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>Pair <span class='op'>=</span> <span class='va'>pair</span>, <span class='st'>"Unit Index"</span> <span class='op'>=</span> <span class='va'>unit</span>, W <span class='op'>=</span> <span class='va'>w</span>, <span class='st'>"Y$^{obs}$"</span> <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/knitr/man/kable.html'>kable</a></span><span class='op'>(</span>align <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"c"</span>, <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/kableExtra/man/kable_styling.html'>kable_styling</a></span><span class='op'>(</span>position <span class='op'>=</span> <span class='st'>"center"</span><span class='op'>)</span>
</code></pre>
</div>
</details>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Pair
</th>
<th style="text-align:center;">
Unit Index
</th>
<th style="text-align:center;">
W
</th>
<th style="text-align:center;">
Y<span class="math inline">\(^{obs}\)</span>
</th>
<th style="text-align:center;">
Y(0)
</th>
<th style="text-align:center;">
Y(1)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
37
</td>
<td style="text-align:center;">
37
</td>
<td style="text-align:center;">
37
</td>
</tr>
<tr>
<td style="text-align:center;">
I
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
24
</td>
<td style="text-align:center;">
24
</td>
<td style="text-align:center;">
24
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
II
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
25
</td>
<td style="text-align:center;">
25
</td>
<td style="text-align:center;">
25
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
38
</td>
<td style="text-align:center;">
38
</td>
<td style="text-align:center;">
38
</td>
</tr>
<tr>
<td style="text-align:center;">
III
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
53
</td>
<td style="text-align:center;">
53
</td>
<td style="text-align:center;">
53
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
IV
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
50
</td>
<td style="text-align:center;">
50
</td>
<td style="text-align:center;">
50
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
41
</td>
<td style="text-align:center;">
41
</td>
</tr>
<tr>
<td style="text-align:center;">
V
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
59
</td>
<td style="text-align:center;">
59
</td>
<td style="text-align:center;">
59
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
33
</td>
<td style="text-align:center;">
33
</td>
</tr>
<tr>
<td style="text-align:center;">
VI
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
43
</td>
<td style="text-align:center;">
43
</td>
<td style="text-align:center;">
43
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
23
</td>
<td style="text-align:center;">
23
</td>
<td style="text-align:center;">
23
</td>
</tr>
<tr>
<td style="text-align:center;">
VII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
31
</td>
<td style="text-align:center;">
31
</td>
<td style="text-align:center;">
31
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
VIII
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
34
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
27
</td>
<td style="text-align:center;">
27
</td>
</tr>
<tr>
<td style="text-align:center;">
IX
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
22
</td>
<td style="text-align:center;">
22
</td>
<td style="text-align:center;">
22
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
51
</td>
<td style="text-align:center;">
51
</td>
<td style="text-align:center;">
51
</td>
</tr>
<tr>
<td style="text-align:center;">
X
</td>
<td style="text-align:center;">
2
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
34
</td>
<td style="text-align:center;">
34
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="computional-shortcut">Computional Shortcut</h3>
<p>To create the the distribution of the test statistic under the sharp
null hypothesis, we could permute the treatment vector, express for each
unit the outcome observed according to the permuted value of the
treatment and then compute the average of pair differences. This is a
bit cumbersome in terms of programming. In the chapter II of his
textbook, Paul Rosenbaum offers a more efficient procedure:</p>
<ul>
<li>For each unit <em>i</em> of each pair <em>j</em>, its observed
outcome is equal to <span class="math inline">\(Y_{i,j} = W_{i,j}\times
Y_{i,j}(1) + (1-W_{i,j})*Y_{i,j}(0)\)</span>.</li>
<li>The difference in outcomes for the pair <em>i</em> (i.e., the
difference in outcomes between the treated and control units) is equal
to <span class="math inline">\(D_{i} = (W_{i,1} - W_{i,2})(Y_{i,1} -
Y_{i,2})\)</span></li>
<li>Under the sharp null hypothesis of no effect, we have <span
class="math inline">\(Y_{i,j}(0) = Y_{i,j}(1)\)</span> so that <span
class="math inline">\(D_{i} = (W_{i,1} - W_{i,2})(Y_{i,1}(0) -
Y_{i,2}(0))\)</span>.</li>
<li>If the treatment allocation within a pair is <span
class="math inline">\((W_{i,1}, W_{i,2})\)</span> = (0,1), <span
class="math inline">\(D_{i} = - (Y_{i,1}(0) - Y_{i,2}(0))\)</span>. If
the treatment allocation is <span class="math inline">\((W_{i,1},
W_{i,2})\)</span> = (1,0), <span class="math inline">\(D_{i} =
Y_{i,1}(0) - Y_{i,2}(0)\)</span>.</li>
<li><strong>Therefore, under the sharp null hypothesis of no effect, the
randomization of the treatment only changes the sign of the pair
differences in outcomes.</strong></li>
</ul>
<p>In terms of programming, we can proceed as follows:</p>
<ol type="1">
<li>We first compute the observed average of pair differences. We are
now working with a table with 10 pair differences.</li>
<li>We then compute the permutations matrix of all possible treatment
assignments. This is a matrix of 10 rows with 1024 columns.</li>
<li>For each vector of treatment assignment, we compute the average of
pair differences.</li>
</ol>
<h3 id="computing-the-null-distribution-of-the-test-statistic">Computing
the Null Distribution of the Test Statistic</h3>
<p>We compute the observed average of pair differences:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># compute the observed average of pair differences</span>
<span class='va'>average_observed_pair_differences</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>pair</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>pair_difference <span class='op'>=</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>average_pair_differences <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>pair_difference</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pull</span><span class='op'>(</span><span class='va'>average_pair_differences</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The observed average of pair differences is equal to 2.4 <span
class="math inline">\(\mu g/m^{3}\)</span>. We have already computed the
permutations matrix of all treatment assignments and we load this
matrix:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># open the matrix of treatment permutations</span>
<span class='va'>permutations_matrix</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"inputs"</span>, <span class='st'>"1.data"</span>, <span class='st'>"3.toy_example"</span>, <span class='st'>"permutations_matrix.rds"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We store the vector of observed pair differences :</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># store vector of pair differences</span>
<span class='va'>observed_pair_differences</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>pair</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>pair_difference <span class='op'>=</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pull</span><span class='op'>(</span><span class='va'>pair_difference</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We then create a function to compute the randomization distribution
of the test statistic:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># randomization distribution function</span>
<span class='co'># this function takes as inputs the vector of pair differences and the number of pairs</span>
<span class='co'># and then compute the average pair difference according</span>
<span class='co'># to the permuted treatment assignment</span>
<span class='va'>function_randomization_distribution</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>vector_pair_difference</span>, <span class='va'>n_pairs</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>randomization_distribution</span> <span class='op'>=</span> <span class='cn'>NULL</span>
    <span class='va'>n_columns</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>permutations_matrix</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_columns</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>randomization_distribution</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span> <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>vector_pair_difference</span> <span class='op'>*</span> <span class='va'>permutations_matrix</span><span class='op'>[</span>, <span class='va'>i</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_pairs</span>
    <span class='op'>}</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span><span class='op'>)</span>
  <span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We run the function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># get the distribution of permuted test statistics</span>
<span class='va'>distribution_test_statistics</span> <span class='op'>&lt;-</span>
  <span class='fu'>function_randomization_distribution</span><span class='op'>(</span>vector_pair_difference <span class='op'>=</span> <span class='va'>observed_pair_differences</span>, n_pairs <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We plot below the distribution of the test statistic under the sharp
null hypothesis:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># make the graph</span>
<span class='va'>graph_distribution_test_statistic</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span>distribution_test_statistics <span class='op'>=</span> <span class='va'>distribution_test_statistics</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>.</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>distribution_test_statistics</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_histogram</span><span class='op'>(</span>colour <span class='op'>=</span> <span class='st'>"white"</span>, fill <span class='op'>=</span> <span class='va'>my_blue</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_vline</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>average_observed_pair_differences</span>,
             size <span class='op'>=</span> <span class='fl'>1.2</span>,
             colour <span class='op'>=</span> <span class='va'>my_orange</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Permuted Test Statistics"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Counts"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_tufte</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the graph</span>
<span class='va'>graph_distribution_test_statistic</span>
</code></pre>
</div>
</details>
<img src="3_toy_example_randomization_inference_files/figure-html5/unnamed-chunk-11-1.png" width="3000" />
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># save the graph</span>
<span class='fu'>ggsave</span><span class='op'>(</span>
  <span class='va'>graph_distribution_test_statistic</span>,
  filename <span class='op'>=</span> <span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span>
    <span class='st'>"inputs"</span>,
    <span class='st'>"3.outputs"</span>,
    <span class='st'>"3.toy_example"</span>,
    <span class='st'>"distribution_test_statistic_sharp_null.pdf"</span>
  <span class='op'>)</span>,
  width <span class='op'>=</span> <span class='fl'>20</span>,
  height <span class='op'>=</span> <span class='fl'>10</span>,
  units <span class='op'>=</span> <span class='st'>"cm"</span>,
  device <span class='op'>=</span> <span class='va'>cairo_pdf</span>
<span class='op'>)</span>
</code></pre>
</div>
</details>
</div>
<h3 id="computing-the-two-sided-p-value">Computing the Two-Sided
P-Value</h3>
<p>To compute a two-sided <em>p</em>-value, we again follow the
explanations provided by Paul Rosenbaum in the chapter II of his
textbook:</p>
<ol type="1">
<li>We first compute the proportions of permuted test statistics that
are lower and higher than the observed test statistic.</li>
<li>We then double the smallest proportion.</li>
<li>We take the minimum of its value and one. This give us the two-sided
<span class="math inline">\(p\)</span>-value.</li>
</ol>
<p>We implement this procedure as follows:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># number of permutations</span>
<span class='va'>n_permutations</span> <span class='op'>&lt;-</span> <span class='fl'>1024</span>

<span class='co'># compute upper proportion</span>
<span class='va'>upper_p_value</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>distribution_test_statistics</span> <span class='op'>&gt;=</span> <span class='va'>average_observed_pair_differences</span><span class='op'>)</span> <span class='op'>/</span>
  <span class='va'>n_permutations</span>

<span class='co'># compute lower proportion</span>
<span class='va'>lower_p_value</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>distribution_test_statistics</span> <span class='op'>&lt;=</span> <span class='va'>average_observed_pair_differences</span><span class='op'>)</span> <span class='op'>/</span>
  <span class='va'>n_permutations</span>

<span class='co'># double the smallest proportion</span>
<span class='va'>double_smallest_proprotion</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>upper_p_value</span>, <span class='va'>lower_p_value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span>

<span class='co'># take the minimum of this proportion and one</span>
<span class='va'>p_value</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>double_smallest_proprotion</span>, <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The two-sided <em>p</em>-value for the sharp null hypothesis of no
effect is equal to 0.55. We fail to reject the sharp null hypothesis of
no effect, despite having simulated a true constant effect of +3 <span
class="math inline">\(\mu g/m^{3}\)</span>.</p>
<h1
id="computing-a-95-fisherian-intervals-for-a-range-of-sharp-null-hypotheses">Computing
a 95% Fisherian Intervals for a Range of Sharp Null Hypotheses</h1>
<p>In addition to computing the sharp null hypothesis of no effect, we
can make the randomization inference procedure more informative by
computing also the range of constant effects consistent with the data
(i.e., a Fisherian interval). We follow again the explanations provided
by Tirthankar Dasguspta and Donald B. Rubin in their forthcoming
textbook on experimental design: <em>Experimental Design: A
Randomization-Based Perspective</em>.</p>
<h3 id="steps-of-the-procedure">Steps of the Procedure</h3>
<p>Instead of gauging a null effect for all units, we test a set of
sharp null hypotheses <span class="math inline">\(H_{0}^{k}\)</span>:
Y<span class="math inline">\(_{i,j}\)</span>(1) = Y<span
class="math inline">\(_{i,j}\)</span>(0) + <span
class="math inline">\(\tau_{k}\)</span> for <em>k</em> =1,<span
class="math inline">\(\ldots\)</span>, and where <span
class="math inline">\(\tau_{k}\)</span> represents a constant unit-level
treatment effect size.</p>
<p>We must therefore choose of set of constant treatment effects that we
would like to test. Here, we test a set of 81 sharp null hypotheses of
constant treatment effects ranging from -20 to +20 with increments of
0.5.</p>
<p>For each constant treatment effect , we compute the upper -value
associated with the hypothesis <span
class="math inline">\(H_{0}^{k}\)</span>: Y<span
class="math inline">\(_{i,j}\)</span>(1) - Y<span
class="math inline">\(_{i,j}\)</span>(0) <span
class="math inline">\(&gt;\)</span> <span
class="math inline">\(\tau_{k}\)</span> and the lower -value <span
class="math inline">\(H_{0}^{k}\)</span>: Y<span
class="math inline">\(_{i,j}\)</span>(1) - Y<span
class="math inline">\(_{i,j}\)</span>(0) <span
class="math inline">\(&lt;\)</span> <span
class="math inline">\(\tau_{k}\)</span>.</p>
<p>To test each hypothesis, we compute the distribution of the test
statistic. The sequence of hypotheses <span
class="math inline">\(H_{0}^{k}\)</span>: Y<span
class="math inline">\(_{i,j}\)</span>(1) - Y<span
class="math inline">\(_{i,j}\)</span>(0) <span
class="math inline">\(&gt;\)</span> <span
class="math inline">\(\tau_{k}\)</span> forms an upper -value function
of <span class="math inline">\(\tau\)</span>, <span
class="math inline">\(p^{+}(\tau)\)</span>, while the sequence of
alternative hypotheses <span class="math inline">\(H_{0}^{k}\)</span>:
Y<span class="math inline">\(_{i,j}\)</span>(1) - Y<span
class="math inline">\(_{i,j}\)</span>(0) <span
class="math inline">\(&lt;\)</span> <span
class="math inline">\(\tau_{k}\)</span> makes a lower -value function,
<span class="math inline">\(\tau\)</span>, <span
class="math inline">\(p^{-}(\tau)\)</span>. To compute the bounds of the
100(1-<span class="math inline">\(\alpha\)</span>)% Fisherian interval,
we solve <span class="math inline">\(p^{+}(\tau) =
\frac{\alpha}{2}\)</span> for <span class="math inline">\(\tau\)</span>
to get the lower limit and <span class="math inline">\(p^{-}(\tau) =
\frac{\alpha}{2}\)</span> for the upper limit. We set our <span
class="math inline">\(\alpha\)</span> significance level to 0.05 and
thus compute 95% Fisherian intervals. This procedure allows us to get
the range of treatment effects consistent with our data.</p>
<p>As a point estimate of a Fisherian interval, we take the observed
value of our test statistic which is the average of pair differences in
a pollutant concentration. <strong>For avoiding confusion, it is very
important to note that our test statistic is an estimate for the
individual-level treatment effect of an hypothetical experiment and not
for the average treatment effect.</strong></p>
<h3 id="computational-shortcut">Computational Shortcut</h3>
<p>For each hypothesis, we could impute the missing potential outcomes.
Then, we would randomly allocate the treatment, express the observed
outcome and finally compute the average of pair differences. Again, this
is a cumbersome way to proceed. Instead, we use the computional shortcut
provided by Paul Rosenbaum in his textbook.</p>
<ul>
<li>We start by making a sharp null hypothesis of a constant treatment
effect <span class="math inline">\(\tau\)</span> such that <span
class="math inline">\(Y_{i,j}(1) = Y_{i,j}(0) + \tau\)</span>.</li>
<li>For a pair <em>i</em>, recall that the observed pair difference in
outcomes is <span class="math inline">\(D_{i} = (W_{i,1} -
W_{i,2})(Y_{i,1} - Y_{i,2})\)</span>.</li>
<li>Under the sharp hypothesis, we have <span
class="math inline">\(D_{i} = (W_{i,1} - W_{i,2})((Y_{i,1} + \tau
W_{i,1}) - (Y_{i,2} + \tau W_{i,2}))\)</span>.</li>
<li>We rearrange the right-hand side expression and find that <span
class="math inline">\(D_{i} = \tau + (W_{i,1} - W_{i,2})(Y_{i,1}(0) -
Y_{i,2}(0))\)</span></li>
<li>We have <span class="math inline">\(D_{i} - \tau = (W_{i,1} -
W_{i,2})(Y_{i,1}(0) - Y_{i,2}(0))\)</span>. This equation means that the
observed pair difference in outcomes minus the hypothesized treatment
effect is equal to <span class="math inline">\(\pm(Y_{i,1}(0) -
Y_{i,2}(0))\)</span>. We can therefore carry out the randomization
inference procedure seen in the previous section from the vector of
observed pair differences adjusted for the hypothesized treatment
effect.</li>
</ul>
<h3 id="implementation-in-r">Implementation in R</h3>
<p>We start by creating a nested tibble of our vector of observed pair
differences with the set of constant treatment effect sizes we want to
test:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># create a nested dataframe with</span>
<span class='co'># the set of constant treatment effect sizes</span>
<span class='co'># and the vector of observed pair differences</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span>observed_pair_differences <span class='op'>=</span> <span class='va'>observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>data_observed_pair_differences <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>observed_pair_differences</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>data_observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>expand</span><span class='op'>(</span>effect <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='op'>-</span><span class='fl'>20</span>, to <span class='op'>=</span> <span class='fl'>20</span>, by <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the nested table</span>
<span class='va'>ri_data_fi</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 2
   data_observed_pair_differences effect
   &lt;list&gt;                          &lt;dbl&gt;
 1 &lt;dbl [10]&gt;                      -20  
 2 &lt;dbl [10]&gt;                      -19.5
 3 &lt;dbl [10]&gt;                      -19  
 4 &lt;dbl [10]&gt;                      -18.5
 5 &lt;dbl [10]&gt;                      -18  
 6 &lt;dbl [10]&gt;                      -17.5
 7 &lt;dbl [10]&gt;                      -17  
 8 &lt;dbl [10]&gt;                      -16.5
 9 &lt;dbl [10]&gt;                      -16  
10 &lt;dbl [10]&gt;                      -15.5
# ... with 71 more rows</code></pre>
</div>
<p>We then subtract for each pair difference the hypothetical constant
effect:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># function to get the observed statistic</span>
<span class='va'>adjusted_pair_difference_function</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>data_observed_pair_differences</span>, <span class='va'>effect</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>adjusted_pair_difference</span> <span class='op'>&lt;-</span> <span class='va'>data_observed_pair_differences</span> <span class='op'>-</span> <span class='va'>effect</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>adjusted_pair_difference</span><span class='op'>)</span>
  <span class='op'>}</span>

<span class='co'># compute the adjusted pair differences</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    data_adjusted_pair_difference <span class='op'>=</span> <span class='fu'>map2</span><span class='op'>(</span>
      <span class='va'>data_observed_pair_differences</span>,
      <span class='va'>effect</span>,
      <span class='op'>~</span> <span class='fu'>adjusted_pair_difference_function</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 3
   data_observed_pair_differences effect data_adjusted_pair_difference
   &lt;list&gt;                          &lt;dbl&gt; &lt;list&gt;                       
 1 &lt;dbl [10]&gt;                      -20   &lt;dbl [10]&gt;                   
 2 &lt;dbl [10]&gt;                      -19.5 &lt;dbl [10]&gt;                   
 3 &lt;dbl [10]&gt;                      -19   &lt;dbl [10]&gt;                   
 4 &lt;dbl [10]&gt;                      -18.5 &lt;dbl [10]&gt;                   
 5 &lt;dbl [10]&gt;                      -18   &lt;dbl [10]&gt;                   
 6 &lt;dbl [10]&gt;                      -17.5 &lt;dbl [10]&gt;                   
 7 &lt;dbl [10]&gt;                      -17   &lt;dbl [10]&gt;                   
 8 &lt;dbl [10]&gt;                      -16.5 &lt;dbl [10]&gt;                   
 9 &lt;dbl [10]&gt;                      -16   &lt;dbl [10]&gt;                   
10 &lt;dbl [10]&gt;                      -15.5 &lt;dbl [10]&gt;                   
# ... with 71 more rows</code></pre>
</div>
<p>We compute the observed mean of adjusted pair differences:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># compute the observed mean of adjusted pair differences</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>observed_mean_difference <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span>, <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>unnest</span><span class='op'>(</span>cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>observed_mean_difference</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='op'>-</span><span class='va'>data_observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 3
   effect data_adjusted_pair_difference observed_mean_difference
    &lt;dbl&gt; &lt;list&gt;                                           &lt;dbl&gt;
 1  -20   &lt;dbl [10]&gt;                                        22.4
 2  -19.5 &lt;dbl [10]&gt;                                        21.9
 3  -19   &lt;dbl [10]&gt;                                        21.4
 4  -18.5 &lt;dbl [10]&gt;                                        20.9
 5  -18   &lt;dbl [10]&gt;                                        20.4
 6  -17.5 &lt;dbl [10]&gt;                                        19.9
 7  -17   &lt;dbl [10]&gt;                                        19.4
 8  -16.5 &lt;dbl [10]&gt;                                        18.9
 9  -16   &lt;dbl [10]&gt;                                        18.4
10  -15.5 &lt;dbl [10]&gt;                                        17.9
# ... with 71 more rows</code></pre>
</div>
<p>We use the same function_randomization_distribution() to compute the
randomization distribution of the test statistic for each hypothesized
constant effect:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># randomization distribution function</span>
<span class='co'># this function takes as inputs the vector of pair differences and the number of pairs</span>
<span class='co'># and then compute the average pair difference according</span>
<span class='co'># to the permuted treatment assignment</span>
<span class='va'>function_randomization_distribution</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span>, <span class='va'>n_pairs</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>randomization_distribution</span> <span class='op'>=</span> <span class='cn'>NULL</span>
    <span class='va'>n_columns</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>permutations_matrix</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_columns</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>randomization_distribution</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span> <span class='op'>=</span>  <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span> <span class='op'>*</span> <span class='va'>permutations_matrix</span><span class='op'>[</span>, <span class='va'>i</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_pairs</span>
    <span class='op'>}</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span><span class='op'>)</span>
  <span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We run the function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># compute the test statistic distribution</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    randomization_distribution <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span>
      <span class='va'>data_adjusted_pair_difference</span>,
      <span class='op'>~</span> <span class='fu'>function_randomization_distribution</span><span class='op'>(</span><span class='va'>.</span>, n_pairs <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 4
   effect data_adjusted_pair_differ~ observed_mean_d~ randomization_d~
    &lt;dbl&gt; &lt;list&gt;                                &lt;dbl&gt; &lt;list&gt;          
 1  -20   &lt;dbl [10]&gt;                             22.4 &lt;dbl [1,024]&gt;   
 2  -19.5 &lt;dbl [10]&gt;                             21.9 &lt;dbl [1,024]&gt;   
 3  -19   &lt;dbl [10]&gt;                             21.4 &lt;dbl [1,024]&gt;   
 4  -18.5 &lt;dbl [10]&gt;                             20.9 &lt;dbl [1,024]&gt;   
 5  -18   &lt;dbl [10]&gt;                             20.4 &lt;dbl [1,024]&gt;   
 6  -17.5 &lt;dbl [10]&gt;                             19.9 &lt;dbl [1,024]&gt;   
 7  -17   &lt;dbl [10]&gt;                             19.4 &lt;dbl [1,024]&gt;   
 8  -16.5 &lt;dbl [10]&gt;                             18.9 &lt;dbl [1,024]&gt;   
 9  -16   &lt;dbl [10]&gt;                             18.4 &lt;dbl [1,024]&gt;   
10  -15.5 &lt;dbl [10]&gt;                             17.9 &lt;dbl [1,024]&gt;   
# ... with 71 more rows</code></pre>
</div>
<p>We compute the lower and upper <em>p</em>-values functions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># define the p-values functions</span>
<span class='va'>function_fisher_upper_p_value</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>observed_mean_difference</span>,
           <span class='va'>randomization_distribution</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span> <span class='op'>&gt;=</span> <span class='va'>observed_mean_difference</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_permutations</span>
  <span class='op'>}</span>

<span class='va'>function_fisher_lower_p_value</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>observed_mean_difference</span>,
           <span class='va'>randomization_distribution</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span> <span class='op'>&lt;=</span> <span class='va'>observed_mean_difference</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_permutations</span>
  <span class='op'>}</span>

<span class='co'># compute the lower and upper one-sided p-values</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    p_value_upper <span class='op'>=</span> <span class='fu'>map2_dbl</span><span class='op'>(</span>
      <span class='va'>observed_mean_difference</span>,
      <span class='va'>randomization_distribution</span>,
      <span class='op'>~</span> <span class='fu'>function_fisher_upper_p_value</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span>,
    p_value_lower <span class='op'>=</span> <span class='fu'>map2_dbl</span><span class='op'>(</span>
      <span class='va'>observed_mean_difference</span>,
      <span class='va'>randomization_distribution</span>,
      <span class='op'>~</span> <span class='fu'>function_fisher_lower_p_value</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We plot below the lower and upper <em>p</em>-values functions:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># make the graph</span>
<span class='va'>graph_p_value_functions_sharp_nulls</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>effect</span>, <span class='va'>p_value_upper</span>, <span class='va'>p_value_lower</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span><span class='st'>"Upper p-value Function"</span> <span class='op'>=</span> <span class='va'>p_value_upper</span>,
         <span class='st'>"Lower p-value Function"</span> <span class='op'>=</span> <span class='va'>p_value_lower</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pivot_longer</span><span class='op'>(</span>cols <span class='op'>=</span> <span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span>,
               names_to <span class='op'>=</span> <span class='st'>"lower_upper"</span>,
               values_to <span class='op'>=</span> <span class='st'>"p_value"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>.</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>effect</span>, y <span class='op'>=</span> <span class='va'>p_value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_hline</span><span class='op'>(</span>yintercept <span class='op'>=</span> <span class='fl'>0.025</span>, colour <span class='op'>=</span> <span class='va'>my_orange</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span>colour <span class='op'>=</span> <span class='va'>my_blue</span>, size <span class='op'>=</span> <span class='fl'>1.2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span> <span class='op'>~</span> <span class='fu'>fct_rev</span><span class='op'>(</span><span class='va'>lower_upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Hypothetical Constant Treatment Effects"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"p-value"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_tufte</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the graph</span>
<span class='va'>graph_p_value_functions_sharp_nulls</span>
</code></pre>
</div>
</details>
<img src="3_toy_example_randomization_inference_files/figure-html5/unnamed-chunk-19-1.png" width="3000" />
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># save the graph</span>
<span class='fu'>ggsave</span><span class='op'>(</span>
  <span class='va'>graph_p_value_functions_sharp_nulls</span>,
  filename <span class='op'>=</span> <span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span>
    <span class='st'>"inputs"</span>,
    <span class='st'>"3.outputs"</span>,
    <span class='st'>"3.toy_example"</span>,
    <span class='st'>"graph_p_value_functions_sharp_nulls.pdf"</span>
  <span class='op'>)</span>,
  width <span class='op'>=</span> <span class='fl'>20</span>,
  height <span class='op'>=</span> <span class='fl'>10</span>,
  units <span class='op'>=</span> <span class='st'>"cm"</span>,
  device <span class='op'>=</span> <span class='va'>cairo_pdf</span>
<span class='op'>)</span>
</code></pre>
</div>
</details>
</div>
<p>The orange line represents the alpha significance level, set at 5%,
divided by two. We then retrieve the lower and upper bound of the 95%
Fisherian interval:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># retrieve the constant effects with the p-values equal or the closest to 0.025</span>
<span class='va'>ri_data_fi</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    p_value_upper <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>p_value_upper</span> <span class='op'>-</span> <span class='fl'>0.025</span><span class='op'>)</span>,
    p_value_lower <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>p_value_lower</span> <span class='op'>-</span> <span class='fl'>0.025</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>p_value_upper</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>p_value_upper</span><span class='op'>)</span> <span class='op'>|</span>
           <span class='va'>p_value_lower</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>p_value_lower</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># in case two effect sizes have a p-value equal to 0.025, we take the effect size</span>
  <span class='co'># that make the Fisherian interval wider to be conservative</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>fi_lower_95 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span>,
            fi_upper_95 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>As a point estimate, we take the value of the observed average of
pair differences, that is to say 2.4 <span class="math inline">\(\mu
g/m^{3}\)</span>. For this imaginary experiment, our point estimate is
close to the true constant effect but the 95% Fisherian interval is
wide: [-7, 11.5]. The data are consistent with both large negative and
positive constant treatment effects.</p>
<h1 id="comparison-with-neymans-approach">Comparison with Neyman’s
Approach</h1>
<p>We can compare the result of the randomization inference procedure
with the one we would obtain with Neyman’s approach. In that case, the
inference procedure is built to target the average causal effect and the
source of inference is both the randomization of the treatment and the
sampling from a population. We can estimate the finite sample average
effect, <span class="math inline">\(\tau_{\text{fs}}\)</span>, with the
average of observed pair differences <span
class="math inline">\(\hat{\tau}\)</span>:</p>
<p><span class="math display">\[\begin{equation*}
  \hat{\tau} =
\frac{1}{I}\sum_{i=1}^J(Y^{\text{obs}}_{\text{t},i}-Y^{\text{obs}}_{\text{c},i})
= \overline{Y}^{\text{obs}}_{\text{t}} -
\overline{Y}^{\text{obs}}_{\text{c}}
\end{equation*}\]</span></p>
<p>Here, the subscripts <span class="math inline">\(t\)</span> and <span
class="math inline">\(c\)</span> respectively indicate if the unit in a
given pair is treated or not. <span class="math inline">\(I\)</span> is
the number of pairs. Since there are only one treated and one control
unit within each pair, the standard estimate for the sampling variance
of the average of pair differences is not defined. We can however
compute a conservative estimate of the variance, as explained in chapter
10 of <a
href="https://www.cambridge.org/core/books/causal-inference-for-statistics-social-and-biomedical-sciences/71126BE90C58F1A431FE9B2DD07938AB">Imbens
and Rubin (2015)</a>:</p>
<p><span class="math display">\[\begin{equation*}
  \hat{\mathbb{V}}(\hat{\tau}) =
\frac{1}{I(I-1)}\sum_{I=1}^I(Y^{\text{obs}}_{\text{t},i}-Y^{\text{obs}}_{\text{c},i}
- \hat{\tau})^{2}
\end{equation*}\]</span></p>
<p>We finally compute an asymptotic 95% confidence interval using a
Gaussian distribution approximation:</p>
<p><span class="math display">\[\begin{equation*}
\text{CI}_{0.95}(\tau_{\text{fs}}) =\Big( \hat{\tau} - 1.96\times
\sqrt{\hat{\mathbb{V}}(\hat{\tau})},\; \hat{\tau} + 1.96\times
\sqrt{\hat{\mathbb{V}}(\hat{\tau})}\Big)
\end{equation*}\]</span></p>
<p>As in the example of <a
href="https://www.cambridge.org/core/books/causal-inference-for-statistics-social-and-biomedical-sciences/71126BE90C58F1A431FE9B2DD07938AB">Imbens
and Rubin (2015)</a>, we only have here 10 pairs. To build the 95%
confidence interval, we use a <span
class="math inline">\(t\)</span>-distribution with degrees of freedom
equal to I/2-1=9. The 0.975 quantile is equal to 2.262. We compute the
95% confidence interval with the following code:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># we store the number of pairs</span>
<span class='va'>n_pairs</span> <span class='op'>&lt;-</span> <span class='fl'>10</span>

<span class='co'># compute the standard error</span>
<span class='va'>squared_difference</span> <span class='op'>&lt;-</span>
  <span class='op'>(</span><span class='va'>observed_pair_differences</span> <span class='op'>-</span> <span class='va'>average_observed_pair_differences</span><span class='op'>)</span> <span class='op'>^</span> <span class='fl'>2</span>

<span class='co'># compute the standard error</span>
<span class='va'>standard_error</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>/</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>squared_difference</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># compute the standard error</span>
<span class='va'>ci_lower_95</span> <span class='op'>&lt;-</span>
  <span class='va'>average_observed_pair_differences</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/stats/TDist.html'>qt</a></span><span class='op'>(</span><span class='fl'>0.975</span>, <span class='fl'>9</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>standard_error</span>
<span class='va'>ci_upper_95</span> <span class='op'>&lt;-</span>
  <span class='va'>average_observed_pair_differences</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/TDist.html'>qt</a></span><span class='op'>(</span><span class='fl'>0.975</span>, <span class='fl'>9</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>standard_error</span>

<span class='co'># store results</span>
<span class='va'>neyman_data_ci</span> <span class='op'>&lt;-</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span>ci_lower_95 <span class='op'>=</span> <span class='va'>ci_lower_95</span>, ci_upper_95 <span class='op'>=</span> <span class='va'>ci_upper_95</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The 95% confidence interval is equal to [-6.3, 11.1], which is very
similar to the one found with randomization inference. However, this
interval gives the range of <strong>average</strong> treatment effects
consistent with the data.</p>
<h1
id="computing-a-95-fisherian-intervals-for-weak-null-hypotheses">Computing
a 95% Fisherian Intervals For Weak Null Hypotheses</h1>
<p>Finally, many researchers restrain from using randomization inference
as a mode of inference since it assumes that treatment effects are
constant across units. In most applications, this is arguably an
unrealistic assumption. To overcome this limit, <a
href="https://www.tandfonline.com/doi/abs/10.1080/01621459.2020.1750415">Jason
Wu &amp; Peng Ding (2021)</a> propose to adopt a studentized test
statistic that is finite-sample exact under sharp null hypotheses but
also asymptotically conservative for the weak null hypothesis.</p>
<p>In the case of our toy example, this studentized test statistic is
equal to the observed average of pair differences divided by the
standard error of a pairwise experiment. We therefore just follow the
same previous procedure but use the studentized statistic proposed by <a
href="https://www.tandfonline.com/doi/abs/10.1080/01621459.2020.1750415">Jason
Wu &amp; Peng Ding (2021)</a>.</p>
<p>First, we create the data for testing a range of sharp null
hypotheses:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># create a nested dataframe with </span>
<span class='co'># the set of constant treatment effect sizes</span>
<span class='co'># and the vector of observed pair differences</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tibble.html'>tibble</a></span><span class='op'>(</span>observed_pair_differences <span class='op'>=</span> <span class='va'>observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>data_observed_pair_differences <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>observed_pair_differences</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>data_observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>expand</span><span class='op'>(</span>effect <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='op'>-</span><span class='fl'>20</span>, to <span class='op'>=</span> <span class='fl'>20</span>, by <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the nested table</span>
<span class='va'>ri_data_fi_weak</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 2
   data_observed_pair_differences effect
   &lt;list&gt;                          &lt;dbl&gt;
 1 &lt;dbl [10]&gt;                      -20  
 2 &lt;dbl [10]&gt;                      -19.5
 3 &lt;dbl [10]&gt;                      -19  
 4 &lt;dbl [10]&gt;                      -18.5
 5 &lt;dbl [10]&gt;                      -18  
 6 &lt;dbl [10]&gt;                      -17.5
 7 &lt;dbl [10]&gt;                      -17  
 8 &lt;dbl [10]&gt;                      -16.5
 9 &lt;dbl [10]&gt;                      -16  
10 &lt;dbl [10]&gt;                      -15.5
# ... with 71 more rows</code></pre>
</div>
<p>We then subtract for each pair difference the hypothetical constant
effect using the previously used
adjusted_pair_difference_function():</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># compute the adjusted pair differences</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>data_adjusted_pair_difference <span class='op'>=</span> <span class='fu'>map2</span><span class='op'>(</span><span class='va'>data_observed_pair_differences</span>, <span class='va'>effect</span>, <span class='op'>~</span> <span class='fu'>adjusted_pair_difference_function</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi_weak</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 3
   data_observed_pair_differences effect data_adjusted_pair_difference
   &lt;list&gt;                          &lt;dbl&gt; &lt;list&gt;                       
 1 &lt;dbl [10]&gt;                      -20   &lt;dbl [10]&gt;                   
 2 &lt;dbl [10]&gt;                      -19.5 &lt;dbl [10]&gt;                   
 3 &lt;dbl [10]&gt;                      -19   &lt;dbl [10]&gt;                   
 4 &lt;dbl [10]&gt;                      -18.5 &lt;dbl [10]&gt;                   
 5 &lt;dbl [10]&gt;                      -18   &lt;dbl [10]&gt;                   
 6 &lt;dbl [10]&gt;                      -17.5 &lt;dbl [10]&gt;                   
 7 &lt;dbl [10]&gt;                      -17   &lt;dbl [10]&gt;                   
 8 &lt;dbl [10]&gt;                      -16.5 &lt;dbl [10]&gt;                   
 9 &lt;dbl [10]&gt;                      -16   &lt;dbl [10]&gt;                   
10 &lt;dbl [10]&gt;                      -15.5 &lt;dbl [10]&gt;                   
# ... with 71 more rows</code></pre>
</div>
<p>We then compute the observed studentized statistics:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># function to compute neyman t-statistic</span>
<span class='va'>function_neyman_t_stat</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>pair_differences</span>, <span class='va'>n_pairs</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='co'># compute the average of pair differences</span>
  <span class='va'>average_pair_difference</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>pair_differences</span><span class='op'>)</span>
  <span class='co'># compute the standard error</span>
  <span class='va'>squared_difference</span> <span class='op'>&lt;-</span>
    <span class='op'>(</span><span class='va'>pair_differences</span> <span class='op'>-</span> <span class='va'>average_pair_difference</span><span class='op'>)</span> <span class='op'>^</span> <span class='fl'>2</span>
  <span class='co'># compute the standard error</span>
  <span class='va'>standard_error</span> <span class='op'>&lt;-</span>
    <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>/</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>squared_difference</span><span class='op'>)</span><span class='op'>)</span>
  <span class='co'># compute neyman t-statistic</span>
  <span class='va'>neyman_t_stat</span> <span class='op'>&lt;-</span> <span class='va'>average_pair_difference</span> <span class='op'>/</span> <span class='va'>standard_error</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>neyman_t_stat</span><span class='op'>)</span>
<span class='op'>}</span>


<span class='co'># compute the observed mean of adjusted pair differences</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    observed_neyman_t_stat <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span>
      <span class='va'>data_adjusted_pair_difference</span>,
      <span class='op'>~</span> <span class='fu'>function_neyman_t_stat</span><span class='op'>(</span><span class='va'>.</span>, n_pairs <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>unnest</span><span class='op'>(</span>cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>observed_neyman_t_stat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='op'>-</span><span class='va'>data_observed_pair_differences</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi_weak</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 3
   effect data_adjusted_pair_difference observed_neyman_t_stat
    &lt;dbl&gt; &lt;list&gt;                                         &lt;dbl&gt;
 1  -20   &lt;dbl [10]&gt;                                      5.82
 2  -19.5 &lt;dbl [10]&gt;                                      5.69
 3  -19   &lt;dbl [10]&gt;                                      5.56
 4  -18.5 &lt;dbl [10]&gt;                                      5.43
 5  -18   &lt;dbl [10]&gt;                                      5.30
 6  -17.5 &lt;dbl [10]&gt;                                      5.17
 7  -17   &lt;dbl [10]&gt;                                      5.04
 8  -16.5 &lt;dbl [10]&gt;                                      4.91
 9  -16   &lt;dbl [10]&gt;                                      4.78
10  -15.5 &lt;dbl [10]&gt;                                      4.65
# ... with 71 more rows</code></pre>
</div>
<p>We create a function to carry out the randomization inference with
the studentized test statistic:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># randomization distribution function</span>
<span class='co'># this function takes the vector of pair differences</span>
<span class='co'># and then compute the average pair difference according</span>
<span class='co'># to the permuted treatment assignment</span>
<span class='va'>function_randomization_distribution_t_stat</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span>, <span class='va'>n_pairs</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>randomization_distribution</span> <span class='op'>=</span> <span class='cn'>NULL</span>
    <span class='va'>n_columns</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>permutations_matrix</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_columns</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='co'># compute the average of pair differences</span>
      <span class='va'>average_pair_difference</span> <span class='op'>&lt;-</span>
        <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span> <span class='op'>*</span> <span class='va'>permutations_matrix</span><span class='op'>[</span>, <span class='va'>i</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_pairs</span>
      <span class='co'># compute the standard error</span>
      <span class='va'>squared_difference</span> <span class='op'>&lt;-</span>
        <span class='op'>(</span><span class='va'>data_adjusted_pair_difference</span> <span class='op'>-</span> <span class='va'>average_pair_difference</span><span class='op'>)</span> <span class='op'>^</span> <span class='fl'>2</span>
      <span class='co'># compute the standard error</span>
      <span class='va'>standard_error</span> <span class='op'>&lt;-</span>
        <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>/</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>n_pairs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>squared_difference</span><span class='op'>)</span><span class='op'>)</span>
      <span class='co'># compute neyman t-statistic</span>
      <span class='va'>randomization_distribution</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span> <span class='op'>=</span> <span class='va'>average_pair_difference</span> <span class='op'>/</span> <span class='va'>standard_error</span>
    <span class='op'>}</span>
    <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span><span class='op'>)</span>
  <span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We run the function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># compute the test statistic distribution</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    randomization_distribution <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span>
      <span class='va'>data_adjusted_pair_difference</span>,
      <span class='op'>~</span> <span class='fu'>function_randomization_distribution_t_stat</span><span class='op'>(</span><span class='va'>.</span>, n_pairs <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>

<span class='co'># display the table</span>
<span class='va'>ri_data_fi_weak</span>
</code></pre>
</div>
<pre><code># A tibble: 81 x 4
   effect data_adjusted_pair_differ~ observed_neyman~ randomization_d~
    &lt;dbl&gt; &lt;list&gt;                                &lt;dbl&gt; &lt;list&gt;          
 1  -20   &lt;dbl [10]&gt;                             5.82 &lt;dbl [1,024]&gt;   
 2  -19.5 &lt;dbl [10]&gt;                             5.69 &lt;dbl [1,024]&gt;   
 3  -19   &lt;dbl [10]&gt;                             5.56 &lt;dbl [1,024]&gt;   
 4  -18.5 &lt;dbl [10]&gt;                             5.43 &lt;dbl [1,024]&gt;   
 5  -18   &lt;dbl [10]&gt;                             5.30 &lt;dbl [1,024]&gt;   
 6  -17.5 &lt;dbl [10]&gt;                             5.17 &lt;dbl [1,024]&gt;   
 7  -17   &lt;dbl [10]&gt;                             5.04 &lt;dbl [1,024]&gt;   
 8  -16.5 &lt;dbl [10]&gt;                             4.91 &lt;dbl [1,024]&gt;   
 9  -16   &lt;dbl [10]&gt;                             4.78 &lt;dbl [1,024]&gt;   
10  -15.5 &lt;dbl [10]&gt;                             4.65 &lt;dbl [1,024]&gt;   
# ... with 71 more rows</code></pre>
</div>
<p>We compute the lower and upper <em>p</em>-values functions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># define the p-values functions</span>
<span class='va'>function_fisher_upper_p_value</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>observed_neyman_t_stat</span>,
           <span class='va'>randomization_distribution</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span> <span class='op'>&gt;=</span> <span class='va'>observed_neyman_t_stat</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_permutations</span>
  <span class='op'>}</span>

<span class='va'>function_fisher_lower_p_value</span> <span class='op'>&lt;-</span>
  <span class='kw'>function</span><span class='op'>(</span><span class='va'>observed_neyman_t_stat</span>,
           <span class='va'>randomization_distribution</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>randomization_distribution</span> <span class='op'>&lt;=</span> <span class='va'>observed_neyman_t_stat</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_permutations</span>
  <span class='op'>}</span>

<span class='co'># compute the lower and upper one-sided p-values</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    p_value_upper <span class='op'>=</span> <span class='fu'>map2_dbl</span><span class='op'>(</span>
      <span class='va'>observed_neyman_t_stat</span>,
      <span class='va'>randomization_distribution</span>,
      <span class='op'>~</span> <span class='fu'>function_fisher_upper_p_value</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span>,
    p_value_lower <span class='op'>=</span> <span class='fu'>map2_dbl</span><span class='op'>(</span>
      <span class='va'>observed_neyman_t_stat</span>,
      <span class='va'>randomization_distribution</span>,
      <span class='op'>~</span> <span class='fu'>function_fisher_lower_p_value</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We plot below the lower and upper <em>p</em>-values functions:</p>
<div class="layout-chunk" data-layout="l-body-outset">
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># make the graph</span>
<span class='va'>graph_p_value_functions_weak_nulls</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>effect</span>, <span class='va'>p_value_upper</span>, <span class='va'>p_value_lower</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span><span class='st'>"Upper p-value Function"</span> <span class='op'>=</span> <span class='va'>p_value_upper</span>, <span class='st'>"Lower p-value Function"</span> <span class='op'>=</span> <span class='va'>p_value_lower</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pivot_longer</span><span class='op'>(</span>cols <span class='op'>=</span> <span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span>, names_to <span class='op'>=</span> <span class='st'>"lower_upper"</span>, values_to <span class='op'>=</span> <span class='st'>"p_value"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>.</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>effect</span>, y <span class='op'>=</span> <span class='va'>p_value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_hline</span><span class='op'>(</span>yintercept <span class='op'>=</span> <span class='fl'>0.025</span>, colour <span class='op'>=</span> <span class='va'>my_orange</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span>colour <span class='op'>=</span> <span class='va'>my_blue</span>, size <span class='op'>=</span> <span class='fl'>1.2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span> <span class='fu'>fct_rev</span><span class='op'>(</span><span class='va'>lower_upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Hypothetical Constant Treatment Effects"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"p-value"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_tufte</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># display the graph</span>
<span class='va'>graph_p_value_functions_weak_nulls</span>
</code></pre>
</div>
</details>
<img src="3_toy_example_randomization_inference_files/figure-html5/unnamed-chunk-28-1.png" width="3000" />
<details>
<summary>
Please show me the code!
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># save the graph</span>
<span class='fu'>ggsave</span><span class='op'>(</span><span class='va'>graph_p_value_functions_weak_nulls</span>, filename <span class='op'>=</span> <span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"inputs"</span>, <span class='st'>"3.outputs"</span>, <span class='st'>"3.toy_example"</span>, <span class='st'>"graph_p_value_functions_weak_nulls.pdf"</span><span class='op'>)</span>, 
       width <span class='op'>=</span> <span class='fl'>20</span>, height <span class='op'>=</span> <span class='fl'>10</span>, units <span class='op'>=</span> <span class='st'>"cm"</span>, device <span class='op'>=</span> <span class='va'>cairo_pdf</span><span class='op'>)</span>
</code></pre>
</div>
</details>
</div>
<p>The orange line represents the alpha significance level, set at 5%,
divided by two. We then retrieve the lower and upper bound of the 95%
Fisherian interval:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># retrieve the constant effects with the p-values equal or the closest to 0.025</span>
<span class='va'>ri_data_fi_weak</span> <span class='op'>&lt;-</span> <span class='va'>ri_data_fi_weak</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>
    p_value_upper <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>p_value_upper</span> <span class='op'>-</span> <span class='fl'>0.025</span><span class='op'>)</span>,
    p_value_lower <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>p_value_lower</span> <span class='op'>-</span> <span class='fl'>0.025</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>p_value_upper</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>p_value_upper</span><span class='op'>)</span> <span class='op'>|</span>
           <span class='va'>p_value_lower</span> <span class='op'>==</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>p_value_lower</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># in case two effect sizes have a p-value equal to 0.025, we take the effect size</span>
  <span class='co'># that make the Fisherian interval wider to be conservative</span>
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/tidyverse.html'>summarise</a></span><span class='op'>(</span>fi_lower_95 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span>,
            fi_upper_95 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The 95% Fisherian interval is equal to [-7, 11.5]. It is the same
interval found with the randomization inference procedure using the
average of pair differences as a test statistic. It is also very similar
to the interval found with Neyman’s approach.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="updates-and-corrections">Corrections</h3>
<p>If you see mistakes or want to suggest changes, please <a href="https://github.com/lzabrocki/cruise_air_pollution.git/issues/new">create an issue</a> on the source repository.</p>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
